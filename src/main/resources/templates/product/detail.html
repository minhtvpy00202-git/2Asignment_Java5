<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chi tiết sản phẩm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/pages.css}">
</head>
<body>
<div th:replace="layout/layout :: header"></div>

<main class="container" style="padding: 16px;">
    <section class="two-column">
        <div class="detail-image-wrap">
            <img class="detail-image"
                 th:src="${#strings.isEmpty(product.image)} ? @{/images/product1.jpg} : @{|/images/${product.image}|}"
                 alt="product">
            <button class="cart-quick-btn"
                    type="button"
                    data-context="detail"
                    th:attr="data-product-id=${product.id}"
                    th:classappend="${cartProductIds.contains(product.id)} ? 'in-cart'">
                <svg class="cart-icon cart-add" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.44A2 2 0 0 0 9 19h9v-2H9.42a.25.25 0 0 1-.22-.37l.9-1.63h5.6a2 2 0 0 0 1.8-1.1l3.1-6.2A1 1 0 0 0 19.7 6H6.2l-.8-2zM7 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                </svg>
                <svg class="cart-icon cart-check" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.44A2 2 0 0 0 9 19h9v-2H9.42a.25.25 0 0 1-.22-.37l.9-1.63h5.6a2 2 0 0 0 1.8-1.1l3.1-6.2A1 1 0 0 0 19.7 6H6.2l-.8-2zM7 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                    <path d="M16.3 9.7a1 1 0 0 1 1.4 0l1.3 1.3 2.9-2.9a1 1 0 0 1 1.4 1.4l-3.6 3.6a1 1 0 0 1-1.4 0l-2-2a1 1 0 0 1 0-1.4z"/>
                </svg>
            </button>
        </div>
        <div class="card">
            <h3 th:text="${product.name}">Tên sản phẩm</h3>
            <div class="price-row">
                <span class="price-old" th:if="${product.discount != null and product.discount > 0}"
                      th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'">0</span>
                <span class="price-amount"
                      th:text="${#numbers.formatDecimal((product.discount != null and product.discount > 0) ? (product.price - (product.price * product.discount / 100)) : product.price, 0, 'POINT', 0, 'COMMA')}">0</span><span class="price-currency">VNĐ</span>
                <span class="badge sale" th:if="${product.discount != null and product.discount > 0}">
                    Giảm <span th:text="${product.discount}">0</span>%
                </span>
            </div>
            <div style="margin-top: 12px;">
                <div class="size-row">
                    <div class="size-title">Chọn size</div>
                    <div class="size-options size-options-detail"
                         th:attr="data-product-id=${product.id}">
                    <button type="button" class="size-option"
                            th:each="ps : ${product.productSizes}"
                            th:if="${ps.quantity > 0}"
                            th:attr="data-size-id=${ps.size.id},data-size-name=${ps.size.name},data-max=${ps.quantity}"
                            th:text="${ps.size.name}">M</button>
                    <span class="size-disabled"
                          th:each="ps : ${product.productSizes}"
                          th:if="${ps.quantity <= 0}"
                          th:text="${ps.size.name}"
                          style="opacity:0.4; text-decoration:line-through;">M</span>
                    </div>
                </div>
            </div>
            <div class="qty-control">
                <span class="qty-label">Số lượng:</span>
                <button type="button" class="qty-btn" data-action="minus">-</button>
                <input type="number" id="detailQuantity" min="1" value="1">
                <button type="button" class="qty-btn" data-action="plus">+</button>
            </div>
            <p th:text="${product.description}">Mô tả sản phẩm</p>
            <div style="margin-top: 12px;">
                <div id="detailMessage" class="status-message">Vui lòng chọn size và số lượng.</div>
                <div class="detail-actions">
                    <button class="btn" type="button" id="detailAddToCart">Thêm vào giỏ hàng</button>
                    <a class="btn btn-outline" th:href="@{/cart/index}">Xem giỏ hàng</a>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <h4 class="page-title">Mô tả sản phẩm</h4>
        <div class="card">
            <p th:text="${product.description}">Mô tả sản phẩm chi tiết.</p>
        </div>
    </section>

    <section class="section">
        <h4 class="page-title">Đánh giá sản phẩm</h4>
        <div class="card" th:with="avg=${avgRatingValue},
                                   count=${reviewStats != null and reviewStats.reviewCount != null ? reviewStats.reviewCount : 0}">
            <div class="review-summary">
                <div class="review-score">
                    <div class="stars stars-lg" th:attr="aria-label=${#numbers.formatDecimal(avg, 1, 'POINT', 1, 'COMMA')} + ' trên 5 sao'">
                        <span class="star"
                              th:each="i : ${#numbers.sequence(1, 5)}"
                              th:classappend="${i <= avgRatingRounded} ? 'filled' : 'empty'"
                              aria-hidden="true">★</span>
                    </div>
                    <div class="review-score-number">
                        <strong th:text="${#numbers.formatDecimal(avg, 1, 'POINT', 1, 'COMMA')}">0.0</strong>
                        <span>/ 5</span>
                    </div>
                </div>
                <div class="review-count">
                    <span th:text="${count}">0</span> lượt đánh giá
                </div>
            </div>
            <div class="status-message" th:if="${#lists.isEmpty(reviews)}">
                Chưa có đánh giá nào cho sản phẩm này.
            </div>
            <div class="review-list" th:if="${!#lists.isEmpty(reviews)}">
                <div class="review-item" th:each="r : ${reviews}">
                    <div class="review-meta">
                        <strong th:text="${r.account != null ? r.account.fullname : 'Khách hàng'}">Khách hàng</strong>
                        <span class="stars stars-sm" th:attr="aria-label=${r.starRating} + ' trên 5 sao'">
                            <span class="star"
                                  th:each="i : ${#numbers.sequence(1, 5)}"
                                  th:classappend="${i <= r.starRating} ? 'filled' : 'empty'"
                                  aria-hidden="true">★</span>
                        </span>
                        <span class="review-date" th:text="${r.createdAt}">date</span>
                    </div>
                    <p th:if="${r.reviewContent != null and !#strings.isEmpty(r.reviewContent)}"
                       th:text="${r.reviewContent}">Nội dung đánh giá.</p>
                    <div class="review-images" th:if="${r.images != null and !#strings.isEmpty(r.images)}">
                        <img th:each="img : ${#strings.arraySplit(r.images, ',')}"
                             th:src="@{|/images/${img}|}"
                             alt="review image">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <h4 class="page-title">Gợi ý sản phẩm tương tự</h4>
        <div class="product-grid">
            <div class="product-card"
                 th:each="p : ${relatedProducts}"
                 th:with="firstSize=${p.productSizes.?[quantity > 0][0]}"
                 th:data-detail-url="@{|/product/detail/${p.id}|}">
                <div class="product-image-wrap">
                    <div class="product-image-frame">
                        <span class="discount-tag"
                              th:if="${p.discount != null and p.discount > 0}"
                              th:text="'-' + ${#numbers.formatDecimal(p.discount, 0, 'POINT', 0, 'COMMA')} + '%'">-0%</span>
                        <div class="size-overlay">
                            <div class="size-box">
                                <div class="size-title">Chọn size nhanh</div>
                                <div class="size-options">
                                    <a th:each="ps : ${p.productSizes}"
                                       th:if="${ps.quantity > 0}"
                                       th:href="@{|/cart/add/${p.id}?sizeId=${ps.size.id}|}"
                                       th:text="${ps.size.name}">M</a>
                                    <span class="size-disabled"
                                          th:each="ps : ${p.productSizes}"
                                          th:if="${ps.quantity <= 0}"
                                          th:attr="data-size=${ps.size.name}"
                                          th:text="${ps.size.name}">M</span>
                                </div>
                            </div>
                        </div>
                        <img th:src="${#strings.isEmpty(p.image)} ? @{/images/product1.jpg} : @{|/images/${p.image}|}"
                             alt="product">
                    </div>
                </div>
                <div class="product-info">
                    <a class="product-name product-name-link" th:href="@{|/product/detail/${p.id}|}" th:text="${p.name}">Tên sản phẩm</a>
                    <div class="product-bottom">
                        <div class="price-row">
                            <span class="price-old" th:if="${p.discount != null and p.discount > 0}"
                                  th:text="${#numbers.formatDecimal(p.price, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'">0</span>
                            <span class="price-amount"
                                  th:text="${#numbers.formatDecimal((p.discount != null and p.discount > 0) ? (p.price - (p.price * p.discount / 100)) : p.price, 0, 'POINT', 0, 'COMMA')}">0</span><span class="price-currency">VNĐ</span>
                        </div>
                        <button class="cart-quick-btn"
                                type="button"
                                th:attr="data-product-id=${p.id},data-size-id=${firstSize != null ? firstSize.size.id : ''}"
                                th:classappend="${cartProductIds.contains(p.id)} ? 'in-cart'">
                            <svg class="cart-icon cart-add" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.44A2 2 0 0 0 9 19h9v-2H9.42a.25.25 0 0 1-.22-.37l.9-1.63h5.6a2 2 0 0 0 1.8-1.1l3.1-6.2A1 1 0 0 0 19.7 6H6.2l-.8-2zM7 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                            </svg>
                            <svg class="cart-icon cart-check" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.44A2 2 0 0 0 9 19h9v-2H9.42a.25.25 0 0 1-.22-.37l.9-1.63h5.6a2 2 0 0 0 1.8-1.1l3.1-6.2A1 1 0 0 0 19.7 6H6.2l-.8-2zM7 21a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                                <path d="M16.3 9.7a1 1 0 0 1 1.4 0l1.3 1.3 2.9-2.9a1 1 0 0 1 1.4 1.4l-3.6 3.6a1 1 0 0 1-1.4 0l-2-2a1 1 0 0 1 0-1.4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </section>
</main>

<div th:replace="layout/layout :: footer"></div>
</body>
</html>
